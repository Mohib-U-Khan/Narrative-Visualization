<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Technology Adoption in American Households</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-annotation@2.5.1/dist/d3-annotation.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
    }
    #vis {
      width: 100%;
      height: 600px;
    }
    #controls {
      text-align: center;
      margin: 20px;
    }
    button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div id="vis"></div>
  <div id="controls">
    <button id="prev">Previous</button>
    <button id="next">Next</button>
  </div>

  <script>
    const margin = { top: 50, right: 100, bottom: 50, left: 60 },
          width = 960 - margin.left - margin.right,
          height = 600 - margin.top - margin.bottom;

    const svg = d3.select("#vis")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    let currentScene = 0;
    const scenes = ["scene1", "scene2", "scene3", "explore"];

    const params = {
      selectedTechs: [],
      highlightedTechs: [],
      yearRange: [1960, 2020]
    };

    function loadData(callback) {
      d3.csv("filtered_tech_adoption_14_technologies.csv").then(data => {
        data.forEach(d => {
          d.Year = +d.Year;
          d["Adoption (%)"] = +d["Adoption (%)"];
        });
        callback(data);
      });
    }

    function updateScene(data) {
      svg.selectAll("*").remove();
      const scene = scenes[currentScene];

      if (scene === "scene1") {
        params.selectedTechs = ["Electric power", "Refrigerator", "Microwave", "Smartphone usage", "Social media usage"];
      } else if (scene === "scene2") {
        params.selectedTechs = ["Landline", "Cable TV", "Videocassette recorder"];
      } else if (scene === "scene3") {
        params.selectedTechs = ["Landline", "Households with only mobile phones (no landlines)", "Amazon Prime users"];
      } else if (scene === "explore") {
        params.selectedTechs = [...new Set(data.map(d => d.Entity))];
      }

      drawLineChart(data);
    }

    function drawLineChart(data) {
      const filtered = data.filter(d => params.selectedTechs.includes(d.Entity));

      const x = d3.scaleLinear()
        .domain(d3.extent(filtered, d => d.Year))
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain([0, 100])
        .range([height, 0]);

      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d3.format("d")));

      svg.append("g")
        .call(d3.axisLeft(y));

      const color = d3.scaleOrdinal(d3.schemeCategory10);

      const techs = d3.group(filtered, d => d.Entity);

      svg.selectAll(".line")
        .data(techs)
        .join("path")
        .attr("fill", "none")
        .attr("stroke", d => color(d[0]))
        .attr("stroke-width", 2)
        .attr("d", ([key, values]) => {
          return d3.line()
            .x(d => x(d.Year))
            .y(d => y(d["Adoption (%)"]))
            (values);
        });

      svg.selectAll(".label")
        .data(techs)
        .join("text")
        .attr("transform", ([key, values]) => {
          const last = values[values.length - 1];
          return `translate(${x(last.Year)},${y(last["Adoption (%)"])})`;
        })
        .attr("x", 5)
        .attr("dy", "0.35em")
        .text(d => d[0])
        .style("font-size", "12px")
        .style("fill", d => color(d[0]));
    }

    d3.select("#next").on("click", () => {
      if (currentScene < scenes.length - 1) currentScene++;
      loadData(updateScene);
    });

    d3.select("#prev").on("click", () => {
      if (currentScene > 0) currentScene--;
      loadData(updateScene);
    });

    loadData(updateScene);
  </script>
</body>
</html>
