<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Technology Adoption Trends in American Homes</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
    }
    #vis {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 600px;
    }
    #controls {
      text-align: center;
      margin: 20px;
    }
    #scene-indicator {
      font-size: 1rem;
      color: #666;
      margin-top: 10px;
      font-weight: 500;
      text-align: center;
      margin-bottom: 10px;
    }
    #tooltip {
      position: absolute; 
      visibility: hidden; 
      background: white; 
      border: 1px solid #ccc; 
      padding: 6px 10px; 
      border-radius: 4px; 
      font-size: 0.9rem; 
      pointer-events: none; 
      box-shadow: 0px 0px 5px rgba(0,0,0,0.1);
    }
    button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div id="scene-description"
      style="
        position: absolute;
        left: 40px;
        top: 120px;
        width: 320px;
        font-family: sans-serif;
        font-size: 18px;
        line-height: 1.9;
        color: #222;
      ">
  </div>
  <h1 style="text-align: center; padding: 20px; margin: 0;">
    Technology Adoption Trends in American Homes
  </h1>
  <div id="vis"></div>
  <div id="controls">
    <button id="prev">Previous</button>
    <button id="next">Next</button>
  </div>
  <div id="scene-indicator"></div>
  <div id="tooltip"></div>

  <script>
    const margin = { top: 50, right: 150, bottom: 50, left: 60 },
          width = 960 - margin.left - margin.right,
          height = 600 - margin.top - margin.bottom;

    const outerSvg = d3.select("#vis")
      .append("svg")
      .attr("width", width + margin.left + margin.right + 160)  // keep space for legend
      .attr("height", height + margin.top + margin.bottom);

    const svg = outerSvg.append("g")
      .attr("transform", `translate(${margin.left + 138},${margin.top})`);

    let currentScene = 0;
    let lockedTech = null;
    const scenes = ["scene1", "scene2", "scene3", "explore"];

    const params = {
      selectedTechs: [],
      highlightedTechs: [],
      yearRange: [1960, 2020]
    };

    const sceneDescriptions = {
      scene1: {
        title: "Scene 1: Growth Over Time",
        body: "Notice how different technologies like electricity and microwaves adopted at vastly different speeds across decades. Earlier innovations took decades to reach mass adoption, while newer ones like smartphones spread rapidly."
      },
      scene2: {
        title: "Scene 2: Rise and Fall",
        body: "Some technologies like landlines and cable TV dominated for years before declining. This scene highlights the lifecycle of now-declining technologies."
      },
      scene3: {
        title: "Scene 3: Disruption",
        body: "Disruptive tech such as smartphones and streaming reshaped how we communicate and consume media, often replacing older tech like landlines and cable."
      },
      explore: {
        title: "Now Explore!",
        body: "This is your turn to explore freely. Hover over the legend or click on lines to isolate technologies and make your own comparisons."
      }
    };

    function loadData(callback) {
      d3.csv("filtered_tech_adoption_14_technologies.csv").then(data => {
        data.forEach(d => {
          d.Year = +d.Year;
          d["Adoption (%)"] = +d["Adoption (%)"];
        });
        callback(data);
      });
    }

    function updateScene(data) {
      svg.selectAll("*").remove();
      const scene = scenes[currentScene];

      if (scene === "scene1") {
        params.selectedTechs = ["Electric power", "Refrigerator", "Microwave", "Smartphone usage", "Social media usage", "Internet"];
      } else if (scene === "scene2") {
        params.selectedTechs = ["Landline", "Cable TV", "Videocassette recorder"];
      } else if (scene === "scene3") {
        params.selectedTechs = ["Landline", "Cable TV", "Amazon Prime users", "Smartphone usage"];
      } else if (scene === "explore") {
        params.selectedTechs = [...new Set(data.map(d => d.Entity))];
      }

      drawLineChart(data);
      const desc = sceneDescriptions[scene];
        d3.select("#scene-description").html(`
          <h3 style="margin-bottom: 12px; font-size: 22px;">${desc.title}</h3>
          <p style="margin-top: 0; font-size: 18px; line-height: 1.9;">${desc.body}</p>
        `);
    }

    function updateSceneIndicator() {
      d3.select("#scene-indicator")
        .style("margin-left", "30px")
        .text(`${currentScene + 1} of 4`);
    }

    function updateNavigationButtons() {
      d3.select("#prev")
        .style("visibility", currentScene === 0 ? "hidden" : "visible");

      d3.select("#next")
        .style("visibility", currentScene === scenes.length - 1 ? "hidden" : "visible");
    }

    function drawLineChart(data) {
      const filtered = data.filter(d => params.selectedTechs.includes(d.Entity));
      const scene = scenes[currentScene];
      const tooltipCircle = svg.append("circle")
        .attr("r", 5)
        .attr("fill", "#000")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .style("visibility", "hidden");

      const x = d3.scaleLinear()
        .domain(d3.extent(filtered, d => d.Year))
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain([0, 100])
        .range([height, 0]);

      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d3.format("d")));

      svg.append("g")
        .call(d3.axisLeft(y));

      const color = d3.scaleOrdinal()
        .domain([
            "Smartphone usage", "Social media usage", "Amazon Prime users",
            "Internet", "Tablet", "Landline", "Cable TV",
            "Videocassette recorder",
            "Electric power", "Refrigerator", "Microwave",
            "Computer", "Dishwasher"
        ])
        .range([
            "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b",
            "#e377c2", "#7f7f7f", "#bcbd22", "#17becf", "#393b79", "#9c9ede",
            "#6b6ecf", "#e6550d"
        ]);

      const techs = d3.group(filtered, d => d.Entity);

      svg.selectAll(".line")
        .data(techs)
        .join(
          enter => enter.append("path")
            .attr("class", "line")
            .attr("fill", "none")
            .attr("stroke", d => color(d[0]))
            .attr("stroke-width", 2)
            .attr("d", ([key, values]) => {
              return d3.line()
                .x(d => x(d.Year))
                .y(d => y(d["Adoption (%)"]))
                (values);
            })
            .each(function() {
              const totalLength = this.getTotalLength();

              d3.select(this)
                .attr("stroke-dasharray", `${totalLength} ${totalLength}`)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                .duration(1500)
                .ease(d3.easePolyInOut.exponent(3))
                .attr("stroke-dashoffset", 0);
            })
            .on("click", function(event, d) {
              const label = d[0];

              if (lockedTech === label) {
                lockedTech = null;

                svg.selectAll(".line").style("opacity", 1).attr("stroke-width", 2);
                d3.selectAll(".legend-text").style("opacity", 1).style("font-weight", "normal");
                d3.selectAll(".legend-circle").style("opacity", 1);
              } else {
                lockedTech = label;

                svg.selectAll(".line").style("opacity", 0.1).attr("stroke-width", 2);
                d3.selectAll(".legend-text").style("opacity", 0.2).style("font-weight", "normal");
                d3.selectAll(".legend-circle").style("opacity", 0.2);

                svg.selectAll(".line")
                  .filter(([key]) => key === label)
                  .style("opacity", 1)
                  .attr("stroke-width", 4)
                  .raise();

                const className = `.legend-${label.replace(/\s+/g, '-')}`;
                d3.selectAll(className).style("opacity", 1).style("font-weight", "bold");
              }

              event.stopPropagation();
            }),

          update => update
            .attr("stroke", d => color(d[0]))
            .attr("d", ([key, values]) => {
              return d3.line()
                .x(d => x(d.Year))
                .y(d => y(d["Adoption (%)"]))
                (values);
            }),

          exit => exit.remove()
        );

      const tooltip = d3.select("#tooltip");
      svg.selectAll(".hover-target")
        .data(techs)
        .join("path")
        .attr("class", "hover-target")
        .attr("fill", "none")
        .attr("stroke", "transparent")
        .attr("stroke-width", 15)
        .attr("d", ([key, values]) => {
          return d3.line()
            .x(d => x(d.Year))
            .y(d => y(d["Adoption (%)"]))
            (values);
        })
        .on("click", function(event, d) {
          const label = d[0];
          if (scene !== "explore") return;

          if (lockedTech === label) {
            // Unlock
            lockedTech = null;

            svg.selectAll(".line").style("opacity", 1).attr("stroke-width", 2);
            d3.selectAll(".legend-text").style("opacity", 1).style("font-weight", "normal");
            d3.selectAll(".legend-circle").style("opacity", 1);
          } else {
            // Lock this tech
            lockedTech = label;

            svg.selectAll(".line").style("opacity", 0.1).attr("stroke-width", 2);
            d3.selectAll(".legend-text").style("opacity", 0.2).style("font-weight", "normal");
            d3.selectAll(".legend-circle").style("opacity", 0.2);

            svg.selectAll(".line")
              .filter(([key]) => key === label)
              .style("opacity", 1)
              .attr("stroke-width", 4)
              .raise();

            const className = `.legend-${label.replace(/\s+/g, '-')}`;
            d3.selectAll(className).style("opacity", 1).style("font-weight", "bold");
          }

          event.stopPropagation(); // Prevents body click from firing immediately
        })
        .on("mousemove", function(event, d) {
          if (lockedTech !== null && lockedTech !== d[0]) return;
          if (scene !== "explore") return;

          const [xPos, yPos] = d3.pointer(event);
          const nearest = d3.least(d[1], p => Math.abs(x(p.Year) - xPos));

          if (!nearest) return;

          tooltip.style("visibility", "visible")
                .style("left", `${event.pageX + 12}px`)
                .style("top", `${event.pageY - 28}px`)
                .html(`<strong>${d[0]}</strong><br>Year: ${nearest.Year}<br>Adoption: ${nearest["Adoption (%)"]}%`);
          tooltipCircle
            .attr("cx", x(nearest.Year))
            .attr("cy", y(nearest["Adoption (%)"]))
            .style("fill", color(d[0])) // use line color
            .style("visibility", "visible");
        })
        .on("mouseleave", function() {
          if (scene !== "explore") return;
          tooltip.style("visibility", "hidden");
          tooltipCircle.style("visibility", "hidden");
        });

      svg.selectAll(".label")
        .data(techs)
        .join("text")
        .attr("transform", ([key, values]) => {
          const last = values[values.length - 1];
          return `translate(${x(last.Year)},${y(last["Adoption (%)"])})`;
        })
        .attr("x", 5)
        .attr("dy", "0.35em")
        //.text(d => d[0])
        .style("font-size", "12px")
        .style("fill", d => color(d[0]));

        const legend = svg.append("g")
            .attr("transform", `translate(${width + 20}, 0)`); 

      Array.from(techs.entries()).forEach(([key], i) => {
          const yOffset = i * 20;

          legend.append("circle")
              .attr("cx", 0)
              .attr("cy", yOffset)
              .attr("r", 6)
              .attr("class", `legend-circle legend-${key.replace(/\s+/g, '-')}`)
              .style("fill", color(key));

          legend.append("text")
              .attr("x", 10)
              .attr("y", yOffset)
              .attr("class", `legend-text legend-${key.replace(/\s+/g, '-')}`)
              .text(key)
              .style("font-size", "12px")
              .attr("alignment-baseline", "middle");
          });
      
      legend.selectAll(".legend-text, .legend-circle")
        .on("mouseover", function(event, d) {
          if (lockedTech !== null) return;
          if (scene !== "explore") return;
          const label = d3.select(this).text() || d3.select(this).attr("class").match(/legend-([^\s]+)/)[1].replace(/-/g, ' ');

          svg.selectAll(".line").style("opacity", 0.1);
          d3.selectAll(".legend-text").style("opacity", 0.2).style("font-weight", "normal");
          d3.selectAll(".legend-circle").style("opacity", 0.2);

          svg.selectAll(".line")
            .filter(([key]) => key === label)
            .style("opacity", 1)
            .attr("stroke-width", 4)
            .raise();

          const className = `.legend-${label.replace(/\s+/g, '-')}`;
          d3.selectAll(className).style("opacity", 1).style("font-weight", "bold");
        })
        .on("mouseout", function() {
          if (lockedTech !== null) return;
          if (scene !== "explore") return;
          svg.selectAll(".line").style("opacity", 1).attr("stroke-width", 2);
          d3.selectAll(".legend-text").style("opacity", 1).style("font-weight", "normal");
          d3.selectAll(".legend-circle").style("opacity", 1);
        })
        .on("click", function(event, d) {
          const label = d3.select(this).text() || d3.select(this).attr("class").match(/legend-([^\s]+)/)[1].replace(/-/g, ' ');
          if (scene !== "explore") return;

          if (lockedTech === label) {
            // Unlock if already locked
            lockedTech = null;

            // Reset visuals
            svg.selectAll(".line").style("opacity", 1).attr("stroke-width", 2);
            d3.selectAll(".legend-text").style("opacity", 1).style("font-weight", "normal");
            d3.selectAll(".legend-circle").style("opacity", 1);
          } else {
            // Lock new item
            lockedTech = label;

            // Dim all
            svg.selectAll(".line").style("opacity", 0.1).attr("stroke-width", 2);
            d3.selectAll(".legend-text").style("opacity", 0.2).style("font-weight", "normal");
            d3.selectAll(".legend-circle").style("opacity", 0.2);

            // Highlight selected
            svg.selectAll(".line")
              .filter(([key]) => key === label)
              .style("opacity", 1)
              .attr("stroke-width", 4)
              .raise();

            const className = `.legend-${label.replace(/\s+/g, '-')}`;
            d3.selectAll(className).style("opacity", 1).style("font-weight", "bold");
          }

          event.stopPropagation();
        });

        d3.select("body").on("click", function() {
          if (lockedTech !== null) {
            lockedTech = null;

            // Reset visuals
            svg.selectAll(".line").style("opacity", 1).attr("stroke-width", 2);
            d3.selectAll(".legend-text").style("opacity", 1).style("font-weight", "normal");
            d3.selectAll(".legend-circle").style("opacity", 1);
          }
        });

        svg.append("text")
          .attr("text-anchor", "middle")
          .attr("x", width / 2)
          .attr("y", height + 40)  // a bit below the axis
          .style("font-size", "14px")
          .style("font-weight", "bold")
          .text("Year");

        // Y-axis label
        svg.append("text")
          .attr("text-anchor", "middle")
          .attr("transform", `rotate(-90)`)
          .attr("x", -height / 2)
          .attr("y", -45)  // a bit to the left of the axis
          .style("font-size", "14px")
          .style("font-weight", "bold")
          .text("% of U.S. Households with Technology");

        const annotationsByScene = {
          scene1: [
            {
              note: {
                title: "Slow Adoption",
                label: "Electric power took decades to reach mass adoption (1910-1955).",
                wrap: 150
              },
              x: x(1930),
              y: y(70),
              dx: -50,
              dy: -30
            },
            {
              note: {
                title: "Faster Growth",
                label: "Microwaves became common much faster than earlier tech (1970-1995).",
                wrap: 150
              },
              x: x(1986),
              y: y(65),
              dx: -60,
              dy: -40
            },
            {
              note: {
                title: "Rapid Adoption",
                label: "Smartphones and social media spread in less than 10 years (2008-2016).",
                wrap: 150
              },
              x: x(2015),
              y: y(55),
              dx: 80,
              dy: 40
            }
          ],
          scene2: [
            {
              note: {
                title: "Peak and Decline",
                label: "Landlines reached peak adoption (~95%) around 2000, but usage has dropped significantly since.",
                wrap: 160
              },
              x: x(2000),
              y: y(95),
              dx: -400,
              dy: 0
            },
            {
              note: {
                title: "Slowing Growth",
                label: "Cable TV peaked around the early 2000s before household adoption began to decline.",
                wrap: 150
              },
              x: x(1997),
              y: y(62),
              dx: 0,
              dy: 50
            },
            {
              note: {
                title: "Short Lifespan",
                label: "Videocassette recorders were adopted rapidly in the 1980s but quickly faded by the 2000s.",
                wrap: 160
              },
              x: x(2002),
              y: y(87),
              dx: 170,
              dy: 30
            }
          ],
          scene3: [
            {
              note: {
                title: "Outpaced by Innovation",
                label: "Smartphones have overtaken landlines as primary communication tools (2010-2020).",
                wrap: 160
              },
              x: x(2013),
              y: y(57),
              dx: -90,
              dy: 90
            },
            {
              note: {
                title: "The Rise of Streaming",
                label: "Streaming services like Amazon Prime have surged since 2014, reflecting a major shift to on-demand media (2014–2020).",
                wrap: 150
              },
              x: x(2017),
              y: y(25),
              dx: 95,
              dy: -20
            }
          ]
        };

        if (annotationsByScene[scene]) {
          const makeAnnotations = d3.annotation()
            .type(d3.annotationLabel)
            .annotations(annotationsByScene[scene]);

          const annotationGroup = svg.append("g")
            .attr("class", "annotation-group")
            .style("opacity", 0)
            .call(makeAnnotations);

          annotationGroup
            .transition()
            .delay(1600)
            .duration(800)
            .style("opacity", 1);
        }
    }

    d3.select("#next").on("click", () => {
      if (currentScene < scenes.length - 1) currentScene++;
      loadData(data => {
        updateScene(data);
        updateNavigationButtons();
        updateSceneIndicator();  
      });
    });

    d3.select("#prev").on("click", () => {
      if (currentScene > 0) currentScene--;
      loadData(data => {
        updateScene(data);
        updateNavigationButtons();
        updateSceneIndicator();  
      });
    });

    loadData(data => {
      updateScene(data);
      updateNavigationButtons();
      updateSceneIndicator();  
    });
  </script>
</body>
</html>
